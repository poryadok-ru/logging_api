name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
      - develop
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        run: |
          docker build -t logging_api:latest .
      
      - name: Save Docker image
        run: |
          docker save logging_api:latest | gzip > logging_api.tar.gz
      
      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          source: "logging_api.tar.gz,configs/config.json"
          target: "/opt/logging_api"
          strip_components: 0
      
      - name: Deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            cd /opt/logging_api
            
            # Создаем .env файл
            cat > .env << EOF
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            GIN_MODE=release
            EOF
            
            # Загружаем Docker образ
            docker load < logging_api.tar.gz
            
            # Останавливаем старый контейнер
            docker stop logging_api 2>/dev/null || true
            docker rm logging_api 2>/dev/null || true
            
            # Запускаем новый контейнер
            docker run -d \
              --name logging_api \
              --restart unless-stopped \
              --network host \
              --env-file .env \
              logging_api:latest
            
            # Ждем запуска контейнера
            sleep 5
            
            # Проверяем что контейнер работает
            if ! docker ps | grep -q logging_api; then
              echo "ERROR: Container is not running"
              docker logs logging_api --tail 50
              exit 1
            fi
            
            # Проверяем health endpoint
            echo "Checking health endpoint..."
            for i in {1..10}; do
              if curl -f -s http://localhost:8001/health > /dev/null 2>&1; then
                echo "Health check passed!"
                break
              fi
              if [ $i -eq 10 ]; then
                echo "ERROR: Health check failed after 10 attempts"
                docker logs logging_api --tail 50
                exit 1
              fi
              sleep 2
            done
            
            # Показываем логи
            docker logs logging_api --tail 20
            
            # Очищаем старые образы (оставляем только последние 2)
            docker images logging_api --format "{{.ID}}" | tail -n +3 | xargs -r docker rmi 2>/dev/null || true
            
            echo "Deployment successful!"
      
      - name: Cleanup
        if: always()
        run: |
          rm -f logging_api.tar.gz

